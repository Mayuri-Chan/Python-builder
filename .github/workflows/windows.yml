name: Build Python (Windows)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'meta/3.14'
      vendor_string:
        description: 'Vendor string to embed in the build'
        required: false
        default: 'Mayuri'
  workflow_call:
    inputs:
      branch:
        type: string
        required: true
      vendor_string:
        type: string
        required: false

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Clone Cinder source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ inputs.branch }}
          repository: facebookincubator/cinder
          path: src

      - name: Embed Vendor String
        shell: bash
        run: |
          cd src
          git checkout -b ${{ inputs.vendor_string }} || true
          sed -i "s/return GITVERSION;/return \"\";/" Modules/getbuildinfo.c
          sed -i "s/gitid = GITBRANCH;/gitid = \"${{ inputs.vendor_string }}\";/" Modules/getbuildinfo.c
          git add Modules/getbuildinfo.c
          git config --local user.name "mayuri"
          git config --local user.email "mayuri@mayuri.my.id"
          git commit -m "Set vendor string to ${{ inputs.vendor_string }}"

      - name: Download externals
        working-directory: src/PCbuild
        run: .\get_externals.bat

      - name: Build Python
        working-directory: src/PCbuild
        run: .\build.bat -e -p x64 -c Release

      - name: Prepare Artifacts
        shell: pwsh
        run: |
          $python_exe = "src/PCbuild/amd64/python.exe"
          $ver_full = & $python_exe -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}')"
          $git_hash = git -C src rev-parse --short HEAD
          $dist_zip = "cinder-v$ver_full-$git_hash-windows-x86_64.zip"
          
          echo "TAG=cinder-v$ver_full-$git_hash-win" >> $env:GITHUB_ENV
          echo "PYTHON_VERSION_FULL=$ver_full" >> $env:GITHUB_ENV
          echo "GIT_HASH=$git_hash" >> $env:GITHUB_ENV
          echo "DIST_ZIP=$dist_zip" >> $env:GITHUB_ENV
          
          if (!(Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" -Force }

          # Create ZIP distribution
          if (!(Test-Path "staging")) { New-Item -ItemType Directory -Path "staging" -Force }
          cp -r src/PCbuild/amd64/* staging/
          Get-ChildItem -Path staging -Include *.obj,*.lib,*.exp,*.pch,*.iobj,*.ipdb -Recurse | Remove-Item
          Compress-Archive -Path staging/* -DestinationPath "dist/$dist_zip"

      - name: Apply patch for MSI
        shell: bash
        run: |
          cd src
          patch -p1 < ../windows_msi_fix.patch

      - name: Build bundle
        working-directory: src/Tools/msi
        run: .\build.bat --out ..\..\dist-msi -x64 --skip-doc --bundle

      - name: Prepare MSI Artifacts
        shell: pwsh
        run: |
          $ver_full = $env:PYTHON_VERSION_FULL
          $git_hash = $env:GIT_HASH
          $msi_zip = "cinder-v$ver_full-$git_hash-windows-x86_64-msi.zip"
          
          echo "MSI_ZIP=$msi_zip" >> $env:GITHUB_ENV
          
          if (!(Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" -Force }
          
          # Create MSI distribution by compressing the requested folder
          Compress-Archive -Path src/PCbuild/amd64/en-us/* -DestinationPath "dist/$msi_zip"

      - name: Release Build Artifacts
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${TAG}"
          REPO="${GITHUB_REPOSITORY}"
          TITLE="Python (cinder) ${PYTHON_VERSION_FULL} Windows Build"
          
          # Prepare release notes
          MSVC_VERSION=$(cl 2>&1 | head -n 1)
          NOTES="### ðŸ Python ${PYTHON_VERSION_FULL} Windows Build Information

          | Information | Value |
          | :--- | :--- |
          | **Build Date** | \`$(date)\` |
          | **Compiler** | \`$MSVC_VERSION\` |
          | **Commit** | [${GIT_HASH}](https://github.com/facebookincubator/cinder/tree/$GIT_HASH) |"

          # Create release if it doesn't exist
          if ! gh release view "$TAG" --repo "$REPO" &>/dev/null; then
              echo "Release $TAG does not exist, creating..."
              gh release create "$TAG" --title "$TITLE" --notes "$NOTES" --target "$GITHUB_REF_NAME" --repo "$REPO"
          fi

          # Upload all files in dist folder
          for file in dist/*; do
              if [ -f "$file" ]; then
                  echo "Uploading $file..."
                  gh release upload "$TAG" "$file" --repo "$REPO" --clobber
              fi
          done
